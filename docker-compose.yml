version: '3.3'

services:
  mysql-primary:
    image: mysql:8.0.32
    container_name: mysql-primary
    hostname: mysql-primary
    environment:
      MYSQL_ROOT_PASSWORD: kamo
      MYSQL_DATABASE: testdb
      MYSQL_USER: clusteruser
      MYSQL_PASSWORD: kamo
    ports:
      - "33061:3306"
    volumes:
      - ./config/primary.cnf:/etc/mysql/conf.d/custom.cnf
      - ./data/primary:/var/lib/mysql
    networks:
      mysql-cluster:
        ipv4_address: 172.20.0.10
    command: --server-id=1 --log-bin=mysql-bin --gtid-mode=ON --enforce-gtid-consistency=ON --binlog-format=ROW --relay-log=mysql-relay-bin
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pkamo"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-secondary-1:
    image: mysql:8.0.32
    container_name: mysql-secondary-1
    hostname: mysql-secondary-1
    environment:
      MYSQL_ROOT_PASSWORD: kamo
      MYSQL_DATABASE: testdb
      MYSQL_USER: clusteruser
      MYSQL_PASSWORD: kamo
    ports:
      - "33062:3306"
    volumes:
      - ./config/secondary1.cnf:/etc/mysql/conf.d/custom.cnf
      - ./data/secondary1:/var/lib/mysql
    networks:
      mysql-cluster:
        ipv4_address: 172.20.0.11
    command: --server-id=2 --log-bin=mysql-bin --gtid-mode=ON --enforce-gtid-consistency=ON --binlog-format=ROW --relay-log=mysql-relay-bin
    restart: unless-stopped
    depends_on:
      - mysql-primary
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pkamo"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-secondary-2:
    image: mysql:8.0.32
    container_name: mysql-secondary-2
    hostname: mysql-secondary-2
    environment:
      MYSQL_ROOT_PASSWORD: kamo
      MYSQL_DATABASE: testdb
      MYSQL_USER: clusteruser
      MYSQL_PASSWORD: kamo
    ports:
      - "33063:3306"
    volumes:
      - ./config/secondary2.cnf:/etc/mysql/conf.d/custom.cnf
      - ./data/secondary2:/var/lib/mysql
    networks:
      mysql-cluster:
        ipv4_address: 172.20.0.12
    command: --server-id=3 --log-bin=mysql-bin --gtid-mode=ON --enforce-gtid-consistency=ON --binlog-format=ROW --relay-log=mysql-relay-bin
    restart: unless-stopped
    depends_on:
      - mysql-primary
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pkamo"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-router:
    image: mysql/mysql-router:8.0.32
    container_name: mysql-router
    hostname: mysql-router
    entrypoint: ["mysqlrouter"]
    command: ["-c", "/etc/mysqlrouter/mysqlrouter.conf"]
    ports:
      - "6446:6446"  # Read/Write port
      - "6447:6447"  # Read-Only port
      - "6448:6448"  # Read/Write X Protocol
      - "6449:6449"  # Read-Only X Protocol
    volumes:
      - ./config/router.conf:/etc/mysqlrouter/mysqlrouter.conf:ro
    networks:
      mysql-cluster:
        ipv4_address: 172.20.0.20
    depends_on:
      - mysql-primary
      - mysql-secondary-1
      - mysql-secondary-2
    restart: unless-stopped

networks:
  mysql-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

